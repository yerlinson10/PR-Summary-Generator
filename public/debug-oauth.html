<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Debug OAuth vs Manual Token</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #0d1117;
      color: #c9d1d9;
      padding: 20px;
      line-height: 1.6;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    
    h1 {
      color: #58a6ff;
      margin-bottom: 30px;
      font-size: 32px;
    }
    
    .comparison {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .card {
      background: #161b22;
      border: 1px solid #30363d;
      border-radius: 8px;
      padding: 20px;
    }
    
    .card h2 {
      color: #58a6ff;
      margin-bottom: 15px;
      font-size: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .card h3 {
      color: #8b949e;
      margin-top: 20px;
      margin-bottom: 10px;
      font-size: 16px;
    }
    
    .scope-list {
      list-style: none;
      padding: 0;
    }
    
    .scope-list li {
      padding: 8px 12px;
      margin: 5px 0;
      background: #0d1117;
      border-radius: 4px;
      border-left: 3px solid #238636;
    }
    
    .scope-list li.missing {
      border-left-color: #f85149;
      background: #1a1414;
    }
    
    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: bold;
      margin-left: 8px;
    }
    
    .badge.ok {
      background: #238636;
      color: white;
    }
    
    .badge.missing {
      background: #f85149;
      color: white;
    }
    
    button {
      background: #238636;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
      margin: 5px;
    }
    
    button:hover {
      background: #2ea043;
    }
    
    button.secondary {
      background: #21262d;
      border: 1px solid #30363d;
    }
    
    button.secondary:hover {
      background: #30363d;
    }
    
    pre {
      background: #0d1117;
      border: 1px solid #30363d;
      border-radius: 6px;
      padding: 15px;
      overflow-x: auto;
      font-size: 13px;
      margin: 10px 0;
    }
    
    .error {
      background: #1a1414;
      border: 1px solid #f85149;
      color: #f85149;
      padding: 15px;
      border-radius: 6px;
      margin: 20px 0;
    }
    
    .success {
      background: #0f1814;
      border: 1px solid #238636;
      color: #3fb950;
      padding: 15px;
      border-radius: 6px;
      margin: 20px 0;
    }
    
    .warning {
      background: #1c1810;
      border: 1px solid #d29922;
      color: #e3b341;
      padding: 15px;
      border-radius: 6px;
      margin: 20px 0;
    }
    
    .actions {
      margin: 30px 0;
      padding: 20px;
      background: #161b22;
      border: 1px solid #30363d;
      border-radius: 8px;
    }
    
    .spinner {
      border: 3px solid #30363d;
      border-top-color: #58a6ff;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîç Debug: OAuth vs Manual Token</h1>
    
    <div class="actions">
      <button onclick="analyzeTokens()">üî¨ Analizar Tokens</button>
      <button onclick="testRepoAccess()" class="secondary">üì¶ Probar Acceso a Repos</button>
      <button onclick="compareScopes()" class="secondary">‚öñÔ∏è Comparar Scopes</button>
      <button onclick="location.reload()" class="secondary">üîÑ Refrescar</button>
    </div>
    
    <div id="results"></div>
  </div>

  <script>
    async function analyzeTokens() {
      const resultsDiv = document.getElementById('results')
      resultsDiv.innerHTML = '<div class="spinner"></div>'
      
      try {
        const oauthToken = localStorage.getItem('github_token')
        const oauthScopes = localStorage.getItem('github_scopes') || ''
        
        if (!oauthToken) {
          resultsDiv.innerHTML = '<div class="error">‚ùå No hay token OAuth. Por favor inicia sesi√≥n.</div>'
          return
        }
        
        // Obtener informaci√≥n del token OAuth
        const oauthResponse = await fetch('https://api.github.com/user', {
          headers: {
            'Authorization': `Bearer ${oauthToken}`,
            'Accept': 'application/vnd.github.v3+json'
          }
        })
        
        const oauthUser = await oauthResponse.json()
        const oauthScopesFromHeader = oauthResponse.headers.get('x-oauth-scopes') || ''
        const oauthScopesList = oauthScopesFromHeader.split(',').map(s => s.trim()).filter(Boolean)
        
        // Obtener repos con OAuth
        const oauthReposResponse = await fetch('https://api.github.com/user/repos?per_page=100&affiliation=owner,collaborator,organization_member&visibility=all', {
          headers: {
            'Authorization': `Bearer ${oauthToken}`,
            'Accept': 'application/vnd.github.v3+json'
          }
        })
        
        const oauthRepos = await oauthReposResponse.json()
        
        // Obtener organizaciones
        const oauthOrgsResponse = await fetch('https://api.github.com/user/orgs', {
          headers: {
            'Authorization': `Bearer ${oauthToken}`,
            'Accept': 'application/vnd.github.v3+json'
          }
        })
        
        const oauthOrgs = await oauthOrgsResponse.json()
        
        // Scopes recomendados
        const recommendedScopes = ['repo', 'read:org', 'read:user', 'user:email', 'read:project']
        const missingScopes = recommendedScopes.filter(scope => !oauthScopesList.includes(scope))
        
        let html = `
          <div class="card">
            <h2>üîê Token OAuth Actual</h2>
            <p><strong>Usuario:</strong> ${oauthUser.login}</p>
            <p><strong>Token (preview):</strong> ${oauthToken.substring(0, 20)}...</p>
            
            <h3>Scopes Actuales (${oauthScopesList.length})</h3>
            <ul class="scope-list">
              ${oauthScopesList.map(scope => `
                <li>${scope} <span class="badge ok">‚úì</span></li>
              `).join('')}
            </ul>
            
            ${missingScopes.length > 0 ? `
              <h3>‚ö†Ô∏è Scopes Faltantes (${missingScopes.length})</h3>
              <ul class="scope-list">
                ${missingScopes.map(scope => `
                  <li class="missing">${scope} <span class="badge missing">FALTA</span></li>
                `).join('')}
              </ul>
            ` : '<div class="success">‚úÖ Tienes todos los scopes recomendados</div>'}
            
            <h3>üì¶ Repositorios</h3>
            <p><strong>Total:</strong> ${oauthRepos.length}</p>
            <p><strong>Propios:</strong> ${oauthRepos.filter(r => r.owner.login === oauthUser.login).length}</p>
            <p><strong>De organizaciones:</strong> ${oauthRepos.filter(r => r.owner.type === 'Organization').length}</p>
            
            <h3>üè¢ Organizaciones</h3>
            <p><strong>Total:</strong> ${oauthOrgs.length}</p>
            ${oauthOrgs.length > 0 ? `
              <ul class="scope-list">
                ${oauthOrgs.map(org => `<li>@${org.login}</li>`).join('')}
              </ul>
            ` : '<p>No perteneces a organizaciones o no tienes acceso</p>'}
          </div>
        `
        
        // Detectar si faltan scopes cr√≠ticos
        if (missingScopes.includes('repo')) {
          html += `
            <div class="error">
              <h3>üö® Problema Cr√≠tico: Falta el scope "repo"</h3>
              <p>Sin este scope, no puedes acceder a repositorios privados ni a la mayor√≠a de repos de organizaciones.</p>
              <p><strong>Soluci√≥n:</strong></p>
              <ol>
                <li>Revoca el acceso en: <a href="https://github.com/settings/applications" target="_blank">GitHub Settings</a></li>
                <li>Ejecuta: <code>localStorage.clear()</code></li>
                <li>Vuelve a loguear con OAuth</li>
                <li>Aseg√∫rate de aceptar TODOS los permisos</li>
              </ol>
            </div>
          `
        }
        
        if (missingScopes.includes('read:org')) {
          html += `
            <div class="warning">
              <h3>‚ö†Ô∏è Falta el scope "read:org"</h3>
              <p>Sin este scope, no puedes listar tus organizaciones ni acceder a algunos repos de organizaciones.</p>
              <p><strong>Soluci√≥n:</strong> Revoca y re-autoriza con todos los permisos.</p>
            </div>
          `
        }
        
        // Mostrar repos de organizaciones con detalles
        const orgRepos = oauthRepos.filter(r => r.owner.type === 'Organization')
        if (orgRepos.length > 0) {
          const reposByOrg = orgRepos.reduce((acc, repo) => {
            const org = repo.owner.login
            if (!acc[org]) acc[org] = []
            acc[org].push(repo.name)
            return acc
          }, {})
          
          html += `
            <div class="card">
              <h2>üìä Repos por Organizaci√≥n</h2>
              ${Object.entries(reposByOrg).map(([org, repos]) => `
                <h3>@${org} (${repos.length} repos)</h3>
                <details>
                  <summary>Ver repos (${repos.length})</summary>
                  <ul class="scope-list">
                    ${repos.slice(0, 10).map(repo => `<li>${repo}</li>`).join('')}
                    ${repos.length > 10 ? `<li>... y ${repos.length - 10} m√°s</li>` : ''}
                  </ul>
                </details>
              `).join('')}
            </div>
          `
        }
        
        // Informaci√≥n t√©cnica completa
        html += `
          <div class="card">
            <h2>üîß Informaci√≥n T√©cnica</h2>
            <h3>Headers de Respuesta</h3>
            <pre>${JSON.stringify({
              'x-oauth-scopes': oauthScopesFromHeader,
              'x-oauth-client-id': oauthResponse.headers.get('x-oauth-client-id'),
              'x-ratelimit-limit': oauthResponse.headers.get('x-ratelimit-limit'),
              'x-ratelimit-remaining': oauthResponse.headers.get('x-ratelimit-remaining')
            }, null, 2)}</pre>
            
            <h3>Resumen</h3>
            <pre>${JSON.stringify({
              scopesActuales: oauthScopesList,
              scopesFaltantes: missingScopes,
              totalRepos: oauthRepos.length,
              reposPropios: oauthRepos.filter(r => r.owner.login === oauthUser.login).length,
              reposOrganizaciones: orgRepos.length,
              organizaciones: oauthOrgs.length
            }, null, 2)}</pre>
          </div>
        `
        
        resultsDiv.innerHTML = html
        
      } catch (error) {
        resultsDiv.innerHTML = `
          <div class="error">
            <h3>‚ùå Error al analizar</h3>
            <p>${error.message}</p>
            <pre>${error.stack}</pre>
          </div>
        `
      }
    }
    
    async function testRepoAccess() {
      const token = localStorage.getItem('github_token')
      if (!token) {
        alert('No hay token. Por favor inicia sesi√≥n.')
        return
      }
      
      const orgName = prompt('Nombre de la organizaci√≥n a probar:')
      if (!orgName) return
      
      const resultsDiv = document.getElementById('results')
      resultsDiv.innerHTML = '<div class="spinner"></div>'
      
      try {
        const response = await fetch(`https://api.github.com/orgs/${orgName}/repos?per_page=100`, {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Accept': 'application/vnd.github.v3+json'
          }
        })
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`)
        }
        
        const repos = await response.json()
        
        resultsDiv.innerHTML = `
          <div class="success">
            <h3>‚úÖ Acceso exitoso a @${orgName}</h3>
            <p><strong>Repos encontrados:</strong> ${repos.length}</p>
            <ul class="scope-list">
              ${repos.slice(0, 20).map(r => `<li>${r.name} ${r.private ? 'üîí' : 'üåê'}</li>`).join('')}
              ${repos.length > 20 ? `<li>... y ${repos.length - 20} m√°s</li>` : ''}
            </ul>
          </div>
        `
      } catch (error) {
        resultsDiv.innerHTML = `
          <div class="error">
            <h3>‚ùå No se pudo acceder a @${orgName}</h3>
            <p>${error.message}</p>
            <p><strong>Posibles causas:</strong></p>
            <ul>
              <li>La organizaci√≥n no existe</li>
              <li>No tienes acceso a la organizaci√≥n</li>
              <li>La aplicaci√≥n OAuth no est√° autorizada en la organizaci√≥n</li>
              <li>Faltan scopes necesarios (repo, read:org)</li>
            </ul>
          </div>
        `
      }
    }
    
    async function compareScopes() {
      const resultsDiv = document.getElementById('results')
      const manualToken = prompt('Pega tu Personal Access Token manual para comparar:')
      
      if (!manualToken) return
      
      resultsDiv.innerHTML = '<div class="spinner"></div>'
      
      try {
        const oauthToken = localStorage.getItem('github_token')
        
        // OAuth scopes
        const oauthRes = await fetch('https://api.github.com/user', {
          headers: { 'Authorization': `Bearer ${oauthToken}` }
        })
        const oauthScopes = (oauthRes.headers.get('x-oauth-scopes') || '').split(',').map(s => s.trim()).filter(Boolean)
        
        // Manual token scopes
        const manualRes = await fetch('https://api.github.com/user', {
          headers: { 'Authorization': `Bearer ${manualToken}` }
        })
        const manualScopes = (manualRes.headers.get('x-oauth-scopes') || '').split(',').map(s => s.trim()).filter(Boolean)
        
        const allScopes = [...new Set([...oauthScopes, ...manualScopes])]
        
        resultsDiv.innerHTML = `
          <div class="comparison">
            <div class="card">
              <h2>üîê OAuth Token</h2>
              <ul class="scope-list">
                ${allScopes.map(scope => `
                  <li ${oauthScopes.includes(scope) ? '' : 'class="missing"'}>
                    ${scope} 
                    <span class="badge ${oauthScopes.includes(scope) ? 'ok' : 'missing'}">
                      ${oauthScopes.includes(scope) ? '‚úì' : 'FALTA'}
                    </span>
                  </li>
                `).join('')}
              </ul>
            </div>
            
            <div class="card">
              <h2>üîë Manual Token</h2>
              <ul class="scope-list">
                ${allScopes.map(scope => `
                  <li ${manualScopes.includes(scope) ? '' : 'class="missing"'}>
                    ${scope} 
                    <span class="badge ${manualScopes.includes(scope) ? 'ok' : 'missing'}">
                      ${manualScopes.includes(scope) ? '‚úì' : 'FALTA'}
                    </span>
                  </li>
                `).join('')}
              </ul>
            </div>
          </div>
          
          <div class="warning">
            <h3>üìä Diferencias Encontradas</h3>
            <p><strong>Solo en Manual Token:</strong> ${manualScopes.filter(s => !oauthScopes.includes(s)).join(', ') || 'Ninguno'}</p>
            <p><strong>Solo en OAuth Token:</strong> ${oauthScopes.filter(s => !manualScopes.includes(s)).join(', ') || 'Ninguno'}</p>
          </div>
        `
      } catch (error) {
        resultsDiv.innerHTML = `<div class="error">‚ùå ${error.message}</div>`
      }
    }
    
    // Auto-ejecutar al cargar
    window.addEventListener('load', analyzeTokens)
  </script>
</body>
</html>
